<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MU Marketplace - MVP Multiusuario</title>
<style>
body{font-family:Inter,system-ui,Arial;background:#0b0b0d;color:#e6e6e6;padding:18px;}
.card{background:#111;padding:12px;border-radius:8px;margin-bottom:12px}
input,select,button{padding:8px;margin-top:6px;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #333;background:#0e0e10;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #222;text-align:left}
.preview{position:fixed;right:18px;bottom:18px;background:#000;border-radius:8px;padding:6px;display:none;z-index:50}
img.preview-img{max-width:220px;max-height:220px;display:block}
.filters{display:flex;gap:8px}
.filters > *{flex:1}
.small{font-size:13px;color:#aaa}
</style>
</head>
<body>
<h1>MU Marketplace (MVP) üöÄ</h1>

<!-- LOGIN -->
<div class="card" id="authCard">
  <h3>Iniciar sesi√≥n</h3>
  <input type="email" id="email" placeholder="Correo" />
  <button id="loginBtn">Login / Crear cuenta</button>
  <button id="logoutBtn" style="display:none;">Cerrar sesi√≥n</button>
  <p id="authMsg" style="color:#f77;"></p>
</div>

<!-- PUBLICAR ITEM -->
<div class="card">
  <h3>Publicar √≠tem</h3>
  <form id="uploadForm">
    <input name="name" id="name" placeholder="Nombre del √≠tem (ej: Wings of Satan)" required />
    <select name="type" id="type">
      <option value="joyas">Joyas</option>
      <option value="items">Items</option>
      <option value="alas">Alas</option>
      <option value="anillos">Anillos</option>
      <option value="pendientes">Pendientes</option>
    </select>
    <input type="number" name="price" id="price" placeholder="Precio (ej: 100)" required />
    <input name="nick" id="nick" placeholder="Nick del juego (obligatorio)" required />
    <input name="discord" id="discord" placeholder="Discord (ej: user#1234) (obligatorio)" required />
    <input type="file" id="file" accept="image/*" required />
    <button type="submit">Publicar √≠tem</button>
    <p class="small">Nota: im√°genes se suben al bucket 'items' en Supabase.</p>
  </form>
</div>

<!-- FILTROS -->
<div class="card">
  <h3>Buscar / Filtrar</h3>
  <div class="filters">
    <input id="qname" placeholder="Buscar por nombre (palabra clave)" />
    <select id="qtype">
      <option value="">Todos los tipos</option>
      <option value="joyas">Joyas</option>
      <option value="items">Items</option>
      <option value="alas">Alas</option>
      <option value="anillos">Anillos</option>
      <option value="pendientes">Pendientes</option>
    </select>
    <select id="qorder">
      <option value="asc">Precio: menor a mayor</option>
      <option value="desc">Precio: mayor a menor</option>
    </select>
  </div>
  <button id="btnSearch" style="margin-top:8px;">Aplicar filtros</button>
</div>

<!-- LISTA DE ITEMS -->
<div class="card">
  <h3>Resultados</h3>
  <table id="itemsTable">
    <thead><tr><th>√çtem</th><th>Tipo</th><th>Precio</th><th>Nick</th><th>Discord</th><th>Acci√≥n</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- PREVIEW -->
<div class="preview" id="previewBox">
  <img class="preview-img" id="previewImg" src="" alt="preview" />
</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://wsjxfcxfqhguscmzlpgr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzanhmY3hmcWhndXNjbXpscGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjA3NzQsImV4cCI6MjA3MjYzNjc3NH0.gUivKjymj_MDZuSLpSEeO3nGDGZDXDcEjtsDQ-PKNe4';
const BUCKET = 'items';

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;

// helpers preview
const previewBox = document.getElementById('previewBox');
const previewImg = document.getElementById('previewImg');
function showPreview(url){ previewImg.src=url; previewBox.style.display='block'; }
function hidePreview(){ previewBox.style.display='none'; }

// LOGIN
document.getElementById('loginBtn').addEventListener('click', async () => {
  const email = document.getElementById('email').value.trim();
  if(!email){ alert('Ingresa un correo'); return; }
  const { error } = await supabase.auth.signInWithOtp({ email });
  if(error){ document.getElementById('authMsg').textContent = error.message; }
  else { document.getElementById('authMsg').textContent = 'Revisa tu correo para iniciar sesi√≥n'; }
});
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut();
  currentUser = null;
  document.getElementById('logoutBtn').style.display='none';
  document.getElementById('loginBtn').style.display='inline-block';
  document.getElementById('authMsg').textContent='';
});
supabase.auth.onAuthStateChange((event, session)=>{
  if(session?.user){
    currentUser = session.user;
    document.getElementById('logoutBtn').style.display='inline-block';
    document.getElementById('loginBtn').style.display='none';
  } else { currentUser = null; }
});

// SUBIR ITEM
document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser){ alert('Debes iniciar sesi√≥n'); return; }

  const name = document.getElementById('name').value.trim();
  const type = document.getElementById('type').value;
  const price = parseInt(document.getElementById('price').value,10);
  const nick = document.getElementById('nick').value.trim();
  const discord = document.getElementById('discord').value.trim();
  const file = document.getElementById('file').files[0];
  const expire_date = new Date().toISOString(); // fecha autom√°tica

  if(!file){ alert('Selecciona una imagen'); return; }
  const filePath = `${Date.now()}_${file.name.replaceAll(' ','_')}`;

  const { error: upErr } = await supabase.storage.from(BUCKET).upload(filePath, file, { cacheControl:'3600', upsert:false });
  if(upErr){ console.error(upErr); alert(upErr.message); return; }

  const { error: dbErr } = await supabase.from('items').insert([{
    name, type, price, expire_date, nick, discord,
    image_path: filePath, user_id: currentUser.id
  }]);
  if(dbErr){ console.error(dbErr); alert(dbErr.message); return; }

  alert('Item publicado ‚úÖ');
  document.getElementById('uploadForm').reset();
  loadItems();
});

// CARGAR ITEMS
async function loadItems(){
  const { data, error } = await supabase.from('items')
    .select('*')
    .eq('status','activo')
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  const tbody = document.querySelector('#itemsTable tbody');
  tbody.innerHTML='';
  for(const item of data||[]){
    const imgUrl = supabase.storage.from(BUCKET).getPublicUrl(item.image_path).data.publicUrl;
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td class="item-name" data-img="${imgUrl}" style="cursor:help;color:#7fd1ff">${item.name}</td>
      <td>${item.type}</td>
      <td>${item.price}</td>
      <td>${item.nick}</td>
      <td>${item.discord}</td>
      <td>${currentUser?.id===item.user_id?`<button data-id="${item.id}" class="soldBtn">Marcar vendido</button>`:''}</td>
   




