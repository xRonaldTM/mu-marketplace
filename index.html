<!-- supabase-js via CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ====== REMPLAZA ESTO con tus datos de Supabase ======
  const SUPABASE_URL = 'https://wsjxfcxfqhguscmzlpgr.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzanhmY3hmcWhndXNjbXpscGdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNjA3NzQsImV4cCI6MjA3MjYzNjc3NH0.gUivKjymj_MDZuSLpSEeO3nGDGZDXDcEjtsDQ-PKNe4';
  const BUCKET = 'items'; // nombre del bucket
  // =====================================================

  // Inicializar cliente Supabase
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // helper: mostrar preview flotante
  const previewBox = document.getElementById('previewBox');
  const previewImg = document.getElementById('previewImg');

  function showPreview(url){
    previewImg.src = url;
    previewBox.style.display = 'block';
  }
  function hidePreview(){ previewBox.style.display = 'none'; }

  // subir item con imagen
  async function uploadItem(e){
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const type = document.getElementById('type').value;
    const price = document.getElementById('price').value;
    const expire_date = document.getElementById('expire_date').value || null;
    const nick = document.getElementById('nick').value.trim();
    const discord = document.getElementById('discord').value.trim();
    const file = document.getElementById('file').files[0];
    if(!file){ alert('Selecciona una imagen'); return; }

    try{
      // preparar nombre único
      const filePath = `${Date.now()}_${file.name.replaceAll(' ','_')}`;

      // 1) subir imagen al bucket
      const { data: uploadData, error: upErr } = await supabase.storage.from(BUCKET)
        .upload(filePath, file, { cacheControl: '3600', upsert: false });
      if(upErr){ console.error(upErr); alert('Error subiendo la imagen: ' + upErr.message); return; }

      // 2) guardar registro en la tabla
      const { error: dbErr } = await supabase.from('items').insert([{
        name, type, price: parseInt(price,10), expire_date: expire_date || null,
        nick, discord, image_path: filePath
      }]);
      if(dbErr){ console.error(dbErr); alert('Error guardando en BD: ' + dbErr.message); return; }

      alert('Item publicado ✅');
      document.getElementById('uploadForm').reset();
      loadItems(); // refrescar lista
    }catch(err){ console.error(err); alert('Error inesperado'); }
  }

  // cargar items con filtros
  async function loadItems(){
    const qname = document.getElementById('qname').value.trim();
    const qtype = document.getElementById('qtype').value;
    const qorder = document.getElementById('qorder').value;

    let query = supabase.from('items').select('*').eq('status','activo');
    if(qname) query = query.ilike('name', `%${qname}%`);
    if(qtype) query = query.eq('type', qtype);
    query = query.order('price', { ascending: qorder === 'asc' });

    const { data, error } = await query;
    if(error){ console.error(error); return; }

    const tbody = document.querySelector('#itemsTable tbody');
    tbody.innerHTML = '';

    for(const item of data || []){
      const pub = supabase.storage.from(BUCKET).getPublicUrl(item.image_path || '');
      const imgUrl = pub?.data?.publicUrl || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="item-name" data-img="${imgUrl}" style="cursor:help;color:#7fd1ff">${item.name}</td>
        <td>${item.type}</td>
        <td>${item.price}</td>
        <td>${item.nick}</td>
        <td>${item.discord}</td>
        <td><button data-id="${item.id}" class="soldBtn">Marcar vendido</button></td>
      `;

      // hover preview
      tr.querySelector('.item-name').addEventListener('mouseenter', (ev) => {
        const u = ev.target.dataset.img; if(u) showPreview(u);
      });
      tr.querySelector('.item-name').addEventListener('mouseleave', hidePreview);

      // marcar vendido
      tr.querySelector('.soldBtn').addEventListener('click', async (ev) => {
        const id = ev.target.dataset.id;
        await supabase.from('items').update({status:'vendido'}).eq('id', id);
        loadItems();
      });

      tbody.appendChild(tr);
    }
  }

  // Esperar a que el DOM cargue completamente
  document.addEventListener('DOMContentLoaded', () => {
    // Eventos
    document.getElementById('uploadForm').addEventListener('submit', uploadItem);
    document.getElementById('btnSearch').addEventListener('click', loadItems);

    // carga inicial
    loadItems();

    // Realtime (opcional)
    try{
      supabase.channel('public:items')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, payload => {
          loadItems();
        })
        .subscribe();
    }catch(e){ console.log('Realtime no activo o no disponible', e); }
  });
</script>
